name: Printar Valores da Issue

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Número da Issue utilizada"
        type: number

jobs:
  setup-env:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

  get-issue-number:
    needs: setup-env
    runs-on: ubuntu-latest
    outputs:
      rg_name: ${{ steps.set-outputs.outputs.rg_name }}
      sa_name: ${{ steps.set-outputs.outputs.sa_name }}
    steps:
      - name: Parse issue
        id: parse
        uses: onmax/issue-form-parser@v1.4
        with:
          issue_number: ${{ github.event.issue.number }}

      - name: Set outputs
        id: set-outputs
        run: |
          echo "::set-output name=rg_name::${{ fromJson(steps.parse.outputs.payload)['rg_name'] }}"
          echo "::set-output name=sa_name::${{ fromJson(steps.parse.outputs.payload)['sa_name'] }}"

  create-resource-group:
    needs: get-issue-number
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        run: az login --service-principal -u $SERVICE_PRINCIPAL_ID -p $SERVICE_PRINCIPAL_SECRET --tenant $TENANT_ID

      - name: Create Resource Group
        env:
          RG_NAME: ${{ needs.get-issue-number.outputs.rg_name }}
        run: |
          az group create --name $RG_NAME --location eastus

  create-storage-account:
    needs: create-resource-group
    runs-on: ubuntu-latest
    steps:
      - name: Log in to Azure
        run: az login --service-principal -u $SERVICE_PRINCIPAL_ID -p $SERVICE_PRINCIPAL_SECRET --tenant $TENANT_ID

      - name: Create Storage Account
        env:
          RG_NAME: ${{ needs.get-issue-number.outputs.rg_name }}
          SA_NAME: ${{ needs.get-issue-number.outputs.sa_name }}
        run: |
          az storage account create \
            --name $SA_NAME \
            --resource-group $RG_NAME \
            --location eastus \
            --sku Standard_LRS




# name: Printar Valores da Issue

# on:
#   issues:
#     types: [opened]
#   workflow_dispatch:
#     inputs:
#       issue_number:
#         description: "Número da Issue utilizada"
#         type: number

# jobs:
#   get-issue-number:
#     runs-on: ubuntu-latest
#     outputs:
#       payload: ${{ steps.parse.outputs.payload }}
#     steps:
#       - name: Parse issue
#         id: parse
#         uses: onmax/issue-form-parser@v1.4
#         with:
#           issue_number: ${{ github.event.issue.number }}

#       - name: Show parsed payload data
#         run: |
#           echo "${{ steps.parse.outputs.payload }}"
#           echo "${{ fromJson(steps.parse.outputs.payload)['rg_name'] }}"
#           echo "${{ fromJson(steps.parse.outputs.payload)['sa_name'] }}"

